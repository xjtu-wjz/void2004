import{_ as o}from"./ValaxyMain.vue_vue_type_script_setup_true_lang-D6WepyqT.js";import{b as h,e as g,w as t,f as u,a as d,p as r,r as n,g as s,h as a}from"./app-B5BMfZs9.js";const y="/assets/SD1-Dn-kKPap.png",v="/assets/SD2-CEftwiG5.png",f="/assets/SD3-Bl9LxeQc.png",_="/assets/SD4-BSnpYIxU.png",b="/assets/SD5-DG1Fs0GO.png",x="/assets/SD6-Cn2y7cQT.png",A="/assets/SD7-DE7l8uc5.png",w=s("p",null,"Stable Diffusion 是当前最受欢迎的Image generative model，主要原因就是SD model极大提升了diffusion model生成图像的效率，令用户可以在自己的商业级显卡上生成图像。在正式学习SD之前，我们不妨从更原始的图像生成模型开始了解。",-1),M=s("h1",{id:"autoencoder",tabindex:"-1"},[a("Autoencoder "),s("a",{class:"header-anchor",href:"#autoencoder","aria-label":'Permalink to "Autoencoder"'},"​")],-1),D=s("p",null,"包括diffusion model在内的众多生成式模型其实本质上都可以看做是最简单的Autoencoder(AE)的改进版。所以索性我们从AE开始了解。",-1),z=s("p",null,[a("生成图像的原理是，首先将图像压缩，然后基于这个压缩的图像生成新的图像。可以看做这是两个映射，分别是："),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mtext",null,"图像"),s("mo",null,"→"),s("mtext",null,"数据")]),s("annotation",{encoding:"application/x-tex"},"图像 → 数据")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6833em"}}),s("span",{class:"mord cjk_fallback"},"图像"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"→"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6833em"}}),s("span",{class:"mord cjk_fallback"},"数据")])])]),a("和"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mtext",null,"数据"),s("mo",null,"→"),s("mtext",null,"图像")]),s("annotation",{encoding:"application/x-tex"},"数据 → 图像")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6833em"}}),s("span",{class:"mord cjk_fallback"},"数据"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"→"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6833em"}}),s("span",{class:"mord cjk_fallback"},"图像")])])]),a("。既然神经网络能拟合任何分布，那我们就用神经网络来学习他们的映射是什么。于是一个负责编码的叫编码器（encoder），一个负责解码叫做（decoder）。")],-1),k=s("p",null,[a("如图： "),s("img",{src:y,alt:"alt text"})],-1),E=s("figure",null,[s("img",{src:v,alt:"alt text",loading:"lazy",decoding:"async"})],-1),V=s("p",null,"此时我们的学习目标就很明确了：我们希望让模型可以将一张图片压缩再复原，并且复原效果不错，和原来的图片差不多。只要我们提供一张原图像并接受生成出来的图像，就能对模型进行训练而不需要打上标签，整个过程是自监督的。也就是autoencoder(AE)。如下图：",-1),L=s("figure",null,[s("img",{src:f,alt:"alt text",loading:"lazy",decoding:"async"})],-1),P=s("p",null,"这就是最初的AE的设想。但是不难发现，AE存在很严重的过拟合倾向–自编码器很可能只认得训练时提供的压缩数据，例如当我们在训练流程中向编码器提供图片被压缩的数据（比如记作一个数字，1）后，AE在解码过程中学习如何对数字1生成尽可能和原来一样的图像，但是在实际应用时遇到另一个输入（例如数字2），就会不知所措，因为AE只知道怎么将输入“1”解码。后期解决问题的思路主要分成两类–解决AE的过拟合倾向，和利用AE压缩图像，使用压缩结果生成其他模型。",-1),Q=s("h1",{id:"克服ae的过拟合倾向-ddpm和vae的思路",tabindex:"-1"},[a("克服AE的过拟合倾向（DDPM和VAE的思路） "),s("a",{class:"header-anchor",href:"#克服ae的过拟合倾向-ddpm和vae的思路","aria-label":'Permalink to "克服AE的过拟合倾向（DDPM和VAE的思路）"'},"​")],-1),S=s("p",null,"先来看variational autoencoder（变分自编码器，VAE）的思路。VAE的想法是，现在不让AE的encoder输出一个确定的值，而是输出一个在一定区间内的变量，例如同时输出均值和方差。这样的策略防止了AE的decoder死记硬背。另一方面是VAE限制编码器必须学习产生尽可能和正太分布相似的分布，换句话说需要尽可能地将图像压缩输出转换为一个符合正态分布的变量。这是因为我们在生成图像的时候通常也是从正态分布中随机采样的，因此需要让encoder的输出对齐。",-1),N=s("figure",null,[s("img",{src:_,alt:"alt text",loading:"lazy",decoding:"async"})],-1),W=s("p",null,"因此VAE的训练任务有两个。首先最小化encoder的输出和正态分布之间的差别；其次最小化生成图像和原图像的差距。损失函数表示为：",-1),B=s("p",null,[s("span",{class:"katex-display"},[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("semantics",null,[s("mrow",null,[s("mi",null,"l"),s("mi",null,"o"),s("mi",null,"s"),s("mi",null,"s"),s("mo",null,":"),s("mo",{stretchy:"false"},"("),s("mi",{mathvariant:"normal"},"∣"),s("mover",{accent:"true"},[s("mi",null,"x"),s("mo",null,"^")]),s("mo",null,"−"),s("mi",null,"x"),s("msup",null,[s("mi",{mathvariant:"normal"},"∥"),s("mn",null,"2")]),s("mo",null,"−"),s("mi",null,"s"),s("mi",null,"i"),s("mi",null,"m"),s("mo",{stretchy:"false"},"("),s("mi",null,"N"),s("mo",{stretchy:"false"},"("),s("mi",null,"μ"),s("mo",{separator:"true"},","),s("msup",null,[s("mi",null,"σ"),s("mn",null,"2")]),s("mo",{stretchy:"false"},")"),s("mo",{separator:"true"},","),s("mi",null,"N"),s("mo",{stretchy:"false"},"("),s("mn",null,"0"),s("mo",{separator:"true"},","),s("mi",null,"I"),s("mo",{stretchy:"false"},")"),s("mo",{stretchy:"false"},")"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"loss: (|\\hat{x} - x\\|^2 - sim(N(\\mu, \\sigma^2), N(0, I))) ")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6944em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),s("span",{class:"mord mathnormal"},"oss"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},":"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mopen"},"("),s("span",{class:"mord"},"∣"),s("span",{class:"mord accent"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.6944em"}},[s("span",{style:{top:"-3em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord mathnormal"},"x")]),s("span",{style:{top:"-3em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"accent-body",style:{left:"-0.2222em"}},[s("span",{class:"mord"},"^")])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.1141em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mord"},[s("span",{class:"mord"},"∥"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8641em"}},[s("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"2")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.1141em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"s"),s("span",{class:"mord mathnormal"},"im"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal",style:{"margin-right":"0.10903em"}},"N"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"μ"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.03588em"}},"σ"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8641em"}},[s("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"2")])])])])])])]),s("span",{class:"mclose"},")"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.10903em"}},"N"),s("span",{class:"mopen"},"("),s("span",{class:"mord"},"0"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.07847em"}},"I"),s("span",{class:"mclose"},")))")])])])])],-1),$=s("p",null,"其中的分布与分布之间的差距可以用一个指标叫做KL散度来衡量，因此VAE的改动也可以被看做正则化方法，称之为KL正则化。",-1),I=s("p",null,"但是VAE对重建生成的图像的约束条件少，生成图像的质量其实不高。主要因为VAE的编码和解码过程都用的神经网络，中间过程可解释性太差，我们只能对编码器的输出（一个正态分布）和解码器的输出（生成的图像）加以限制。对此涌现了对VAE进行改进的新方法–diffusion model DDPM，以对具体的解码编码过程加上更多的限制。",-1),G=s("p",null,"DDPM的想法是：既然VAE的目标是输出一个正态分布，不断加噪也可以达到这个目的，那干脆就直接用一个完全可知的加噪过程取代encoder神经网络给出正态分布。",-1),K=s("figure",null,[s("img",{src:b,alt:"alt text",loading:"lazy",decoding:"async"})],-1),j=s("p",null,[a("既然加了噪，那么现在decoder的任务就是去噪。decoder也不是一个解释不清的神经网络了，而是预测每个去噪步骤的网络。DDPM的核心是第t个去噪操作尽可能地抵消第t个加噪操作。详细原理可以在"),s("a",{href:"https://www.void2024.top/posts/Denoising%20Diffusion%20Probabilistic%20Models",target:"_blank",rel:"noreferrer"},"Paper-reading-DDPM专栏"),a("中看。")],-1),R=s("p",null,"总的来说DDPM将VAE干的事分成这几个步骤：",-1),C=s("ul",null,[s("li",null,"将生成正态分布的过程转换为一个完全可控的加噪过程。（不可学习）"),s("li",null,"将生成过程转换为一个可学习的去噪过程。"),s("li",null,"每一次加噪去噪对整张图片操作（操作尺寸不变）。")],-1),H=s("p",null,"但DDPM也有问题。尤其明显的是DDPM加噪去噪过程环环相扣，一步跟一步耗时长，而且每次加噪去噪针对一整张图片进行操作，计算资源消耗非常大。",-1),O=s("h1",{id:"利用ae的图像压缩功能",tabindex:"-1"},[a("利用AE的图像压缩功能 "),s("a",{class:"header-anchor",href:"#利用ae的图像压缩功能","aria-label":'Permalink to "利用AE的图像压缩功能"'},"​")],-1),T=s("p",null,"由于AE的过拟合倾向，干脆不用AE生成图片，而专职压缩图片，再使用其他模型根据压缩结果生成图像。这就是Vector Quantised-Variational AutoEncoder (VQVAE) 的思路。",-1),U=s("p",null,"在这里AE的encoder需要进行一些修改。AE的编码器需要输出一个离散向量。这是因为transformer等模型只能输出离散图像，所以必须进行对齐。具体让AE输出离散向量的方法是，依然令编码器输出连续向量，但是通过某种离散化操作将其映射为离散向量对齐到嵌入层的向量上。具体地，AE输出的离散向量是一个二维的向量，可以理解为是将原图像按照一定比例缩小的离散“小图像”。",-1),F=s("figure",null,[s("img",{src:x,alt:"alt text",loading:"lazy",decoding:"async"})],-1),J=s("p",null,"训练时，首先训练VQVAE模型，然后训练一个压缩图片生成模型（例如transformer）；生成图像时，使用transformer等生成一个压缩图像，然后使用VQVAE的解码器按照压缩图像生成真实图像。之所以不直接用transformer来生成原本大小图像，而只让他生成压缩图像的原因是，运算次数与像素平方数成正比，计算开销太大。但是使用AE压缩一下的话，开销就能减少。将VQVAE的嵌入向量和后续解码部分视为一个模块的话，可以认为VQVAE对VAE方法使用了正则化技术，也称VQ正则化。",-1),Y=s("p",null,[s("strong",null,"现在我们正式开始介绍SD模型。")],-1),q=s("h1",{id:"abstract-intro",tabindex:"-1"},[a("Abstract & Intro "),s("a",{class:"header-anchor",href:"#abstract-intro","aria-label":'Permalink to "Abstract & Intro"'},"​")],-1),X=s("p",null,"以往尽管扩散模型在像素空间中取得了惊人的效果，但是扩散模型的计算开销实在太大。对此论文提出了一种隐式扩散模型，能够很好地平衡图像压缩和尽可能生成高质量细节丰富图像。LDM借鉴了VQVAE的思路，“先压缩，再生成”，将图像压缩，解码器学习如何从压缩图像生成真实图像，然后再来一个模型学习如何生成压缩图像。",-1),Z=s("p",null,"还有一件有趣的事，作者发现在DDPM反向去噪生成图像的过程中，前半部分主要集中于生成关键的语义信息，而后半部分的去噪只是令生成图像在细节上有更多不同。因此我们有了一个朴素的想法–干脆直接让DDPM只负责前面的关键语义信息生成，后面的交给VAE足矣。",-1),ss=s("p",null,"我们后面的重点放在两方面：第一，LDM的AE是如何设计的，达到了压缩和生成图像质量的平衡。第二，LDM是如何利用交叉注意力机制达到带约束的图像生成的。",-1),as=s("h1",{id:"method",tabindex:"-1"},[a("Method "),s("a",{class:"header-anchor",href:"#method","aria-label":'Permalink to "Method"'},"​")],-1),ts=s("h4",{id:"ae的实现方法",tabindex:"-1"},[a("AE的实现方法 "),s("a",{class:"header-anchor",href:"#ae的实现方法","aria-label":'Permalink to "AE的实现方法"'},"​")],-1),ls=s("p",null,"文章中的“感知压缩模型”（或者叫图像压缩模型）与VQGAN的几乎完全一致。普通的AE我们知道会使用重建图像和原图像的差距训练。LDM的AE参考了VQGAN的设置方式，将重建损失改成了感知损失，并增加基于patch的对抗误差。这种方法与VQGAN又有所不同。由于VQGAN的输出端会接到transformer，因此编码器的输出需要经过离散化成为离散向量。但是LDM的压缩图像生成模型用的是DDPM，处理的是连续向量，自然也就不需要离散化这一步，换成普通的正则化即可。文章中先后采用了KL正则化和VQ正则化。",-1),ns=s("p",null,"相较于VQGAN，LDM的编码器有明显优势，在于其可以将图像压缩为带一定空间结构的二维向量，而VQGAN只能将图像转换为一维向量，因此LDM能处理的图像大小明显大于VQGAN。注意LDM的编码器是通用的，这意味LDM不用像先前的压缩-生成二阶段模型一样，换一个任务就得换一个压缩模型。",-1),es=s("h4",{id:"ldm",tabindex:"-1"},[a("LDM "),s("a",{class:"header-anchor",href:"#ldm","aria-label":'Permalink to "LDM"'},"​")],-1),ms=s("p",null,[a("LDM的反向去噪过程和DDPM完全一致，只不过训练图像从真实图像上的"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"x"),s("mi",null,"t")])]),s("annotation",{encoding:"application/x-tex"},"x_{t}")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.5806em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),a("变成了经过压缩之后的图像"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"z"),s("mi",null,"t")])]),s("annotation",{encoding:"application/x-tex"},"z_{t}")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.5806em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.04398em"}},"z"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.044em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])])])])]),a("，因此原损失函数变为：")],-1),is=s("p",null,[s("span",{class:"katex-display"},[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("semantics",null,[s("mrow",null,[s("msub",null,[s("mi",null,"L"),s("mrow",null,[s("mi",null,"L"),s("mi",null,"D"),s("mi",null,"M")])]),s("mo",null,"="),s("msub",null,[s("mi",{mathvariant:"double-struck"},"E"),s("mrow",null,[s("mtext",null,"encode"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")"),s("mo",{separator:"true"},","),s("mi",null,"ϵ"),s("mo",null,"∼"),s("mi",{mathvariant:"script"},"N"),s("mo",{stretchy:"false"},"("),s("mn",null,"0"),s("mo",{separator:"true"},","),s("mn",null,"1"),s("mo",{stretchy:"false"},")"),s("mo",{separator:"true"},","),s("mi",null,"t")])]),s("mrow",null,[s("mo",{fence:"true"},"["),s("mi",{mathvariant:"normal"},"∥"),s("mi",null,"ϵ"),s("mo",null,"−"),s("msub",null,[s("mi",null,"ϵ"),s("mi",null,"θ")]),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"z"),s("mi",null,"t")]),s("mo",{separator:"true"},","),s("mi",null,"t"),s("mo",{stretchy:"false"},")"),s("msubsup",null,[s("mi",{mathvariant:"normal"},"∥"),s("mn",null,"2"),s("mn",null,"2")]),s("mo",{fence:"true"},"]")])]),s("annotation",{encoding:"application/x-tex"},"L_{LDM} = \\mathbb{E}_{\\text{encode}(x), \\epsilon \\sim \\mathcal{N}(0,1), t} \\left[ \\| \\epsilon - \\epsilon_\\theta(z_t, t) \\|_2^2 \\right] ")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8333em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"L"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"L"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.02778em"}},"D"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"M")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.2193em","vertical-align":"-0.3552em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathbb"},"E"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3448em"}},[s("span",{style:{top:"-2.5198em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord text mtight"},[s("span",{class:"mord mtight"},"encode")]),s("span",{class:"mopen mtight"},"("),s("span",{class:"mord mathnormal mtight"},"x"),s("span",{class:"mclose mtight"},")"),s("span",{class:"mpunct mtight"},","),s("span",{class:"mord mathnormal mtight"},"ϵ"),s("span",{class:"mrel mtight"},"∼"),s("span",{class:"mord mathcal mtight",style:{"margin-right":"0.14736em"}},"N"),s("span",{class:"mopen mtight"},"("),s("span",{class:"mord mtight"},"0"),s("span",{class:"mpunct mtight"},","),s("span",{class:"mord mtight"},"1"),s("span",{class:"mclose mtight"},")"),s("span",{class:"mpunct mtight"},","),s("span",{class:"mord mathnormal mtight"},"t")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3552em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"minner"},[s("span",{class:"mopen delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size1"},"[")]),s("span",{class:"mord"},"∥"),s("span",{class:"mord mathnormal"},"ϵ"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"ϵ"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3361em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.02778em"}},"θ")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mopen"},"("),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.04398em"}},"z"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2806em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.044em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"t")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathnormal"},"t"),s("span",{class:"mclose"},")"),s("span",{class:"mord"},[s("span",{class:"mord"},"∥"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8641em"}},[s("span",{style:{top:"-2.453em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"2")])]),s("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"2")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.247em"}},[s("span")])])])])]),s("span",{class:"mclose delimcenter",style:{top:"0em"}},[s("span",{class:"delimsizing size1"},"]")])])])])])])],-1),rs=s("h4",{id:"约束机制",tabindex:"-1"},[a("约束机制 "),s("a",{class:"header-anchor",href:"#约束机制","aria-label":'Permalink to "约束机制"'},"​")],-1),cs=s("p",null,[a("我们知道在DDPM中使用了自注意机制从而更好的发掘数据特征，现在我们还希望在生成图像时对生成步骤加入更多的约束。换个角度想，我们认为自注意力机制"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"S"),s("mi",null,"e"),s("mi",null,"l"),s("mi",null,"f"),s("mi",null,"A"),s("mi",null,"t"),s("mi",null,"t"),s("mi",null,"n"),s("mo",{stretchy:"false"},"("),s("mi",null,"A"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mi",null,"A"),s("mi",null,"t"),s("mi",null,"t"),s("mi",null,"e"),s("mi",null,"n"),s("mi",null,"t"),s("mi",null,"i"),s("mi",null,"o"),s("mi",null,"n"),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"W"),s("mi",null,"Q")]),s("mo",null,"⋅"),s("mi",null,"A"),s("mo",{separator:"true"},","),s("msub",null,[s("mi",null,"W"),s("mi",null,"K")]),s("mo",null,"⋅"),s("mi",null,"A"),s("mo",{separator:"true"},","),s("msub",null,[s("mi",null,"W"),s("mi",null,"V")]),s("mo",null,"⋅"),s("mi",null,"A"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"SelfAttn(A) = Attention(W_Q \\cdot A, W_K \\cdot A, W_V \\cdot A)")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),s("span",{class:"mord mathnormal"},"e"),s("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),s("span",{class:"mord mathnormal",style:{"margin-right":"0.10764em"}},"f"),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mord mathnormal"},"tt"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.0361em","vertical-align":"-0.2861em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mord mathnormal"},"tt"),s("span",{class:"mord mathnormal"},"e"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mord mathnormal"},"t"),s("span",{class:"mord mathnormal"},"i"),s("span",{class:"mord mathnormal"},"o"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mopen"},"("),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"Q")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2861em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8778em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.07153em"}},"K")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8778em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.22222em"}},"V")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mclose"},")")])])]),a("其实就是一个A进行自我数据挖掘的过程，而交叉注意力机制"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"C"),s("mi",null,"r"),s("mi",null,"o"),s("mi",null,"s"),s("mi",null,"s"),s("mi",null,"A"),s("mi",null,"t"),s("mi",null,"t"),s("mi",null,"n"),s("mo",{stretchy:"false"},"("),s("mi",null,"A"),s("mo",{separator:"true"},","),s("mi",null,"B"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mi",null,"A"),s("mi",null,"t"),s("mi",null,"t"),s("mi",null,"e"),s("mi",null,"n"),s("mi",null,"t"),s("mi",null,"i"),s("mi",null,"o"),s("mi",null,"n"),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"W"),s("mi",null,"Q")]),s("mo",null,"⋅"),s("mi",null,"A"),s("mo",{separator:"true"},","),s("msub",null,[s("mi",null,"W"),s("mi",null,"K")]),s("mo",null,"⋅"),s("mi",null,"B"),s("mo",{separator:"true"},","),s("msub",null,[s("mi",null,"W"),s("mi",null,"V")]),s("mo",null,"⋅"),s("mi",null,"B"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"CrossAttn(A,B) = Attention(W_Q \\cdot A,W_K \\cdot B,W_V \\cdot B)")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.07153em"}},"C"),s("span",{class:"mord mathnormal"},"ross"),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mord mathnormal"},"tt"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05017em"}},"B"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.0361em","vertical-align":"-0.2861em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mord mathnormal"},"tt"),s("span",{class:"mord mathnormal"},"e"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mord mathnormal"},"t"),s("span",{class:"mord mathnormal"},"i"),s("span",{class:"mord mathnormal"},"o"),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mopen"},"("),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"Q")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.2861em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8778em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.07153em"}},"K")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8778em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05017em"}},"B"),s("span",{class:"mpunct"},","),s("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"W"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.22222em"}},"V")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"⋅"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05017em"}},"B"),s("span",{class:"mclose"},")")])])]),a("可以认为对AB的特征进行了一次融合。现在既然我们希望对输入"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"x")]),s("annotation",{encoding:"application/x-tex"},"x")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.4306em"}}),s("span",{class:"mord mathnormal"},"x")])])]),a("引入其他约束，不妨将其他约束作为额外特征通过交叉注意力机制与源输入"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"x")]),s("annotation",{encoding:"application/x-tex"},"x")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.4306em"}}),s("span",{class:"mord mathnormal"},"x")])])]),a("进行融合。")],-1),ps=s("p",null,"结构图如下。",-1),os=s("figure",null,[s("img",{src:A,alt:"alt text",loading:"lazy",decoding:"async"})],-1),vs={__name:"High-Resolution Image Synthesis with Latent Diffusion Models",setup(hs,{expose:c}){const e=JSON.parse('{"title":"Paper reading--《High-Resolution Image Synthesis with Latent Diffusion Models》","description":"","frontmatter":{"title":"Paper reading--《High-Resolution Image Synthesis with Latent Diffusion Models》","date":"2024-11-08","updated":"2024-11-08","excerpt":"Diffusion model 的集大成者","categories":"Paper-reading","image":"https://raw.githubusercontent.com/xjtu-wjz/void2004/refs/heads/main/pics_for_post/_2024-11-08%20142919.webp","tags":["科研","Generative Models"],"top":1},"headers":[],"relativePath":"pages/posts/High-Resolution Image Synthesis with Latent Diffusion Models.md","path":"/home/runner/work/void2004/void2004/pages/posts/High-Resolution Image Synthesis with Latent Diffusion Models.md","lastUpdated":1736184181000}'),i=d(),m=e.frontmatter||{};return i.meta.frontmatter=Object.assign(i.meta.frontmatter||{},e.frontmatter||{}),r("pageData",e),r("valaxy:frontmatter",m),globalThis.$frontmatter=m,c({frontmatter:{title:"Paper reading--《High-Resolution Image Synthesis with Latent Diffusion Models》",date:"2024-11-08",updated:"2024-11-08",excerpt:"Diffusion model 的集大成者",categories:"Paper-reading",image:"https://raw.githubusercontent.com/xjtu-wjz/void2004/refs/heads/main/pics_for_post/_2024-11-08%20142919.webp",tags:["科研","Generative Models"],top:1}}),(l,us)=>{const p=o;return h(),g(p,{frontmatter:u(m)},{"main-content-md":t(()=>[w,M,D,z,k,E,V,L,P,Q,S,N,W,B,$,I,G,K,j,R,C,H,O,T,U,F,J,Y,q,X,Z,ss,as,ts,ls,ns,es,ms,is,rs,cs,ps,os]),"main-header":t(()=>[n(l.$slots,"main-header")]),"main-header-after":t(()=>[n(l.$slots,"main-header-after")]),"main-nav":t(()=>[n(l.$slots,"main-nav")]),"main-content":t(()=>[n(l.$slots,"main-content")]),"main-content-after":t(()=>[n(l.$slots,"main-content-after")]),"main-nav-before":t(()=>[n(l.$slots,"main-nav-before")]),"main-nav-after":t(()=>[n(l.$slots,"main-nav-after")]),comment:t(()=>[n(l.$slots,"comment")]),footer:t(()=>[n(l.$slots,"footer")]),aside:t(()=>[n(l.$slots,"aside")]),"aside-custom":t(()=>[n(l.$slots,"aside-custom")]),default:t(()=>[n(l.$slots,"default")]),_:3},8,["frontmatter"])}}};export{vs as default};
